<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†æˆæŠ¥è¡¨æå–å·¥å…· / Integrated Report Extraction Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .lang-switcher {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .lang-btn {
            background: #4b6cb7;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: background 0.3s;
        }
        
        .lang-btn:hover {
            background: #3a5999;
        }
        
        .lang-btn.active {
            background: #2c3e50;
        }
        
        .report-type-selector {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .type-btn {
            background: #4b6cb7;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: background 0.3s;
        }
        
        .type-btn:hover {
            background: #3a5999;
        }
        
        .type-btn.active {
            background: #2c3e50;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f9fafc;
            border-radius: 8px;
            border-left: 4px solid #4b6cb7;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
        }
        
        h2 i {
            margin-right: 10px;
            color: #4b6cb7;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #4b6cb7;
            color: white;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .file-input {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #a0aec0;
            border-radius: 8px;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .file-input:hover, .file-input.drag-over {
            border-color: #4b6cb7;
            background: #edf2f7;
        }
        
        .file-input input {
            width: 100%;
            padding: 10px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            pointer-events: none;
        }
        
        .file-label i {
            font-size: 36px;
            color: #4b6cb7;
            margin-bottom: 10px;
        }
        
        .file-label span {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .file-label small {
            font-size: 12px;
            color: #718096;
        }
        
        .selected-files {
            margin-top: 15px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background: #4b6cb7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a5999;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        .btn-success:hover {
            background: #2f855a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .summary {
            background: #e6fffa;
            border-left: 4px solid #38a169;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            border: 1px solid #e2e8f0;
            padding: 12px 15px;
            text-align: left;
        }
        
        th {
            background: #4b6cb7;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background: #f7fafc;
        }
        
        tr:hover {
            background: #edf2f7;
        }
        
        .scroll-container {
            max-height: 500px;
            overflow: auto;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            display: none;
        }
        
        /* é‡‘é¢æ±‡æ€»è¡¨æ ¼æ ·å¼ */
        .amount-table {
            min-width: 1800px;
            font-size: 12px;
        }
        
        .amount-table th {
            background-color: #f1f5fd;
            color: #2c3e50;
            font-weight: 600;
            padding: 10px 6px;
            text-align: left;
            border-bottom: 2px solid #e1e7f0;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .amount-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #eef0f5;
            vertical-align: top;
        }
        
        .amount-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }
        
        .site-cell {
            max-width: 200px;
            word-break: break-all;
            white-space: normal;
        }

        .reserve-row {
            background-color: #f8f9fa;
        }

        .reserve-row:hover {
            background-color: #f0f4ff;
        }

        .negative-amount {
            color: #dc3545;
        }

        .percent-cell {
            text-align: center;
            font-weight: 500;
        }
        
        .tabs-container {
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            border-right: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: #edf2f7;
        }
        
        .tab-btn.active {
            background: white;
            color: #4b6cb7;
            border-bottom: 2px solid #4b6cb7;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7a8aa0;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #c1c9d6;
        }
        
        .export-buttons {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #718096;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .scroll-container {
                max-height: 400px;
            }
            
            .tabs-header {
                flex-direction: column;
            }
            
            .tab-btn {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="title">é›†æˆæŠ¥è¡¨æå–å·¥å…·</h1>
            <p class="subtitle" id="subtitle">æ”¯æŒé€šç”¨ç»“ç®—å•å’ŒIC++ç»“ç®—å•æ•°æ®æå–</p>
        </header>
        
        <div class="content">
            <div class="lang-switcher">
                <button class="lang-btn active" id="lang-zh">ä¸­æ–‡</button>
                <button class="lang-btn" id="lang-en">English</button>
            </div>
            
            <div class="report-type-selector">
                <button class="type-btn active" id="type-general">é€šç”¨ç»“ç®—å• (General Report)</button>
                <button class="type-btn" id="type-icplus">IC++ ç»“ç®—å•</button>
            </div>
            
            <!-- General Report Section -->
            <div id="general-section" class="section">
                <h2><i>ğŸ“‹</i> <span id="section1-title">é€šç”¨ç»“ç®—å•æå–</span></h2>
                <div class="step">
                    <span class="step-number">1</span>
                    <span id="step1">é€‰æ‹©åŒ…å«é€šç”¨ç»“ç®—å•çš„Excelæ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span id="step2">ç‚¹å‡»"é¢„è§ˆæ•°æ®"æŒ‰é’®æŸ¥çœ‹æå–ç»“æœ</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span id="step3">é€‰æ‹©æŠ¥è¡¨ç±»å‹å¹¶ç‚¹å‡»"å¯¼å‡ºExcel"æŒ‰é’®ä¸‹è½½æ±‡æ€»æ–‡ä»¶</span>
                </div>
                
                <div class="file-input" id="generalFileInputArea">
                    <div class="file-label">
                        <i>ğŸ“</i>
                        <span id="generalFileLabel">é€‰æ‹©æ–‡ä»¶</span>
                        <small id="generalFileSmall">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</small>
                    </div>
                    <input type="file" id="generalFileInput" multiple accept=".xlsx">
                    <div class="selected-files" id="generalSelectedFiles"></div>
                </div>
                
                <div class="buttons">
                    <button class="btn-primary" onclick="previewGeneralData()" id="previewGeneralBtn">
                        <i>ğŸ‘ï¸</i> <span id="previewGeneralText">é¢„è§ˆæ•°æ®</span>
                    </button>
                    <button class="btn-success" onclick="downloadGeneralExcel()" id="downloadGeneralBtn" style="display:none">
                        <i>ğŸ“¥</i> <span id="downloadGeneralText">å¯¼å‡ºExcel</span>
                    </button>
                    <button class="btn-secondary" onclick="resetGeneralTool()" id="resetGeneralBtn">
                        <i>ğŸ”„</i> <span id="resetGeneralText">é‡ç½®å·¥å…·</span>
                    </button>
                </div>
                
                <div class="summary" id="generalSummary">
                    <strong id="generalSummaryText">å·²æå– 0 æ¡è®°å½•</strong>
                </div>
                
                <!-- æ–°å¢ï¼šæŠ¥è¡¨ç±»å‹åˆ‡æ¢ -->
                <div id="reportTabs" style="display: none;">
                    <div class="tabs-container">
                        <div class="tabs-header">
                            <button class="tab-btn active" onclick="switchTab('transactions')" id="tab-transactions-btn">
                                <span id="tab-transactions-text">ç»“ç®—å•äº¤æ˜“æ±‡æ€»</span>
                            </button>
                            <button class="tab-btn" onclick="switchTab('amount')" id="tab-amount-btn">
                                <span id="tab-amount-text">ç»“ç®—å•é‡‘é¢æ±‡æ€»</span>
                            </button>
                        </div>
                        <div class="tab-content active" id="tab-transactions">
                            <div class="scroll-container" id="generalTableContainer">
                                <table id="generalPreviewTable">
                                    <thead id="generalTableHeader">
                                        <!-- Table headers will be generated dynamically -->
                                    </thead>
                                    <tbody id="generalTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="export-buttons">
                                <button class="btn-success" onclick="downloadTransactionsExcel()" id="downloadTransactionsBtn">
                                    <i>ğŸ“¥</i> <span id="downloadTransactionsText">å¯¼å‡ºäº¤æ˜“æ±‡æ€»Excel</span>
                                </button>
                            </div>
                        </div>
                        <div class="tab-content" id="tab-amount">
                            <div class="scroll-container" id="amountTableContainer">
                                <table class="amount-table" id="amountPreviewTable">
                                    <thead>
                                        <tr>
                                            <th>Settlement ID</th> 
                                            <th>Processing Period</th>
                                            <th>Wallet ID</th>
                                            <th>Processing Currency</th>
                                            <th>TRANSACTION TOTAL AMOUNT</th>
                                            <th>Settlement Currency</th>
                                            <th>SETTLEMENT TOTAL AMOUNT</th>
                                            <th>TOTAL ACQUIRER FEE</th>
                                            <th>TOTAL NET AMOUNT</th>
                                            <th>Rolling Reserve held</th>
                                            <th>Rolling Reserve released</th>
                                            <th>Rolling Reserve released Period</th>
                                            <th>Wire fee</th>
                                            <th>Other</th>
                                            <th>GRAND TOTAL</th>
                                            <th>Site</th>
                                            <th>Source File</th>
                                        </tr>
                                    </thead>
                                    <tbody id="amountTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="export-buttons">
                                <button class="btn-success" onclick="downloadAmountExcel()" id="downloadAmountBtn">
                                    <i>ğŸ“¥</i> <span id="downloadAmountText">å¯¼å‡ºé‡‘é¢æ±‡æ€»Excel</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- IC++ Report Section -->
            <div id="icplus-section" class="section" style="display:none">
                <h2><i>ğŸ“‹</i> <span id="section2-title">IC++ ç»“ç®—å•æå–</span></h2>
                <div class="step">
                    <span class="step-number">1</span>
                    <span id="step4">é€‰æ‹©åŒ…å«IC++ç»“ç®—å•çš„Excelæ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span id="step5">ç‚¹å‡»"é¢„è§ˆäº¤æ˜“ä¿¡æ¯"æŒ‰é’®æŸ¥çœ‹æå–ç»“æœ</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span id="step6">é€‰æ‹©æŠ¥è¡¨ç±»å‹å¹¶ç‚¹å‡»"å¯¼å‡ºExcel"æŒ‰é’®ä¸‹è½½æ±‡æ€»æ–‡ä»¶</span>
                </div>

                <div class="file-input" id="icplusFileInputArea">
                    <div class="file-label">
                        <i>ğŸ“</i>
                        <span id="icplusFileLabel">é€‰æ‹©æ–‡ä»¶</span>
                        <small id="icplusFileSmall">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</small>
                    </div>
                    <input type="file" id="icplusFileInput" multiple accept=".xlsx">
                    <div class="selected-files" id="icplusSelectedFiles"></div>
                </div>

                <div class="buttons">
                    <button class="btn-primary" onclick="previewTransactions()" id="previewIcplusBtn">
                        <i>ğŸ‘ï¸</i> <span id="previewIcplusText">é¢„è§ˆäº¤æ˜“ä¿¡æ¯</span>
                    </button>
                    <button class="btn-success" onclick="downloadIcplusExcel()" id="downloadIcplusBtn" style="display:none">
                        <i>ğŸ“¥</i> <span id="downloadIcplusText">å¯¼å‡ºExcel</span>
                    </button>
                    <button class="btn-secondary" onclick="resetIcplusTool()" id="resetIcplusBtn">
                        <i>ğŸ”„</i> <span id="resetIcplusText">é‡ç½®å·¥å…·</span>
                    </button>
                </div>

                <div class="summary" id="icplusSummary">
                    <strong id="icplusSummaryText">å·²æå– 0 æ¡äº¤æ˜“è®°å½•</strong>
                </div>

                <!-- IC++æŠ¥è¡¨ç±»å‹åˆ‡æ¢ -->
                <div id="icplusReportTabs" style="display: none;">
                    <div class="tabs-container">
                        <div class="tabs-header">
                            <button class="tab-btn active" onclick="switchIcplusTab('transactions')" id="icplus-tab-transactions-btn">
                                <span id="icplus-tab-transactions-text">ç»“ç®—å•äº¤æ˜“æ±‡æ€»</span>
                            </button>
                            <button class="tab-btn" onclick="switchIcplusTab('amount')" id="icplus-tab-amount-btn">
                                <span id="icplus-tab-amount-text">ç»“ç®—å•é‡‘é¢æ±‡æ€»</span>
                            </button>
                        </div>
                        <div class="tab-content active" id="icplus-tab-transactions">
                            <div class="scroll-container" id="icplusTableContainer">
                                <table id="icplusPreviewTable">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th><th>Date</th><th>Type</th><th>Transaction Amount</th>
                                            <th>Transaction Currency</th><th>Settlement Amount</th><th>Settlement Currency</th>
                                            <th>Interchange Fee</th><th>Scheme Fee</th><th>Acquirer Fee</th><th>Fees</th>
                                            <th>Net Amount</th><th>Card Brand</th><th>Card Product</th><th>Card Number</th>
                                            <th>Card Holder</th><th>Card Issuer</th><th>Card Country</th><th>Customer Country</th>
                                            <th>3DS</th><th>MerchantOrderID</th><th>ARN</th><th>Wallet ID</th><th>Region</th>
                                            <th>Details</th><th>Settlement ID</th>
                                        </tr>
                                    </thead>
                                    <tbody id="icplusTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="export-buttons">
                                <button class="btn-success" onclick="downloadIcplusTransactionExcel()" id="downloadIcplusTransactionsBtn">
                                    <i>ğŸ“¥</i> <span id="downloadIcplusTransactionsText">å¯¼å‡ºäº¤æ˜“æ±‡æ€»Excel</span>
                                </button>
                            </div>
                        </div>
                        <div class="tab-content" id="icplus-tab-amount">
                            <div class="scroll-container" id="icplusAmountTableContainer">
                                <table class="amount-table" id="icplusAmountPreviewTable">
                                    <thead>
                                        <tr>
                                            <th>Settlement ID</th>
                                            <th>Settlement Date</th>
                                            <th>Processing Period</th>
                                            <th>Wallet ID</th>
                                            <th>Processing Currency</th>
                                            <th>Transaction Amount</th>
                                            <th>Settlement Currency</th>
                                            <th>Settlement Amount</th>
                                            <th>Interchange Fee</th>
                                            <th>Scheme Fee</th>
                                            <th>Acquirer Fee</th>
                                            <th>TOTAL NET AMOUNT</th>
                                            <th>RR%</th>
                                            <th>Rolling Reserve held</th>
                                            <th>Rolling Reserve released</th>
                                            <th>Rolling Reserve released Period</th>
                                            <th>Wire fee</th>
                                            <th>Other</th>
                                            <th>GRAND TOTAL</th>
                                            <th>Site</th>
                                            <th>Source File</th>
                                        </tr>
                                    </thead>
                                    <tbody id="icplusAmountTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="export-buttons">
                                <button class="btn-success" onclick="downloadIcplusAmountExcel()" id="downloadIcplusAmountBtn">
                                    <i>ğŸ“¥</i> <span id="downloadIcplusAmountText">å¯¼å‡ºé‡‘é¢æ±‡æ€»Excel</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p id="footerText">é›†æˆæŠ¥è¡¨æå–å·¥å…· &copy; 2025</p>
        </footer>
    </div>

    <script>
        // ä¸­è‹±æ–‡æ–‡æœ¬èµ„æº
        const translations = {
            zh: {
                title: "é›†æˆæŠ¥è¡¨æå–å·¥å…·",
                subtitle: "æ”¯æŒé€šç”¨ç»“ç®—å•å’ŒIC++ç»“ç®—å•æ•°æ®æå–",
                "section1-title": "é€šç”¨ç»“ç®—å•æå–",
                "section2-title": "IC++ ç»“ç®—å•æå–",
                step1: "é€‰æ‹©åŒ…å«é€šç”¨ç»“ç®—å•çš„Excelæ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰",
                step2: "ç‚¹å‡»\"é¢„è§ˆæ•°æ®\"æŒ‰é’®æŸ¥çœ‹æå–ç»“æœ",
                step3: "é€‰æ‹©æŠ¥è¡¨ç±»å‹å¹¶ç‚¹å‡»\"å¯¼å‡ºExcel\"æŒ‰é’®ä¸‹è½½æ±‡æ€»æ–‡ä»¶",
                step4: "é€‰æ‹©åŒ…å«IC++ç»“ç®—å•çš„Excelæ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰",
                step5: "ç‚¹å‡»\"é¢„è§ˆäº¤æ˜“ä¿¡æ¯\"æŒ‰é’®æŸ¥çœ‹æå–ç»“æœ",
                step6: "ç‚¹å‡»\"å¯¼å‡ºExcel\"æŒ‰é’®ä¸‹è½½æ±‡æ€»æ–‡ä»¶",
                previewGeneralText: "é¢„è§ˆæ•°æ®",
                downloadGeneralText: "å¯¼å‡ºExcel",
                resetGeneralText: "é‡ç½®å·¥å…·",
                previewIcplusText: "é¢„è§ˆäº¤æ˜“ä¿¡æ¯",
                downloadIcplusText: "å¯¼å‡º Excel",
                resetIcplusText: "é‡ç½®å·¥å…·",
                generalSummaryText: "å·²æå– 0 æ¡è®°å½•",
                icplusSummaryText: "å·²æå– 0 æ¡äº¤æ˜“è®°å½•",
                footerText: "é›†æˆæŠ¥è¡¨æå–å·¥å…· Â© 2025",
                noFileAlert: "è¯·å…ˆé€‰æ‹©æ–‡ä»¶",
                noDataAlert: "æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®",
                successAlert: "å…±æå–äº† {count} æ¡è®°å½•",
                selectFileText: "é€‰æ‹©æ–‡ä»¶",
                dragDropText: "æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶",
                generalReportBtn: "é€šç”¨ç»“ç®—å• (General Report)",
                icplusReportBtn: "IC++ ç»“ç®—å•",
                "tab-transactions-text": "ç»“ç®—å•äº¤æ˜“æ±‡æ€»",
                "tab-amount-text": "ç»“ç®—å•é‡‘é¢æ±‡æ€»",
                downloadTransactionsText: "å¯¼å‡ºäº¤æ˜“æ±‡æ€»Excel",
                downloadAmountText: "å¯¼å‡ºé‡‘é¢æ±‡æ€»Excel",
                "icplus-tab-transactions-text": "ç»“ç®—å•äº¤æ˜“æ±‡æ€»",
                "icplus-tab-amount-text": "ç»“ç®—å•é‡‘é¢æ±‡æ€»",
                "downloadIcplusTransactionsText": "å¯¼å‡ºäº¤æ˜“æ±‡æ€»Excel",
                "downloadIcplusAmountText": "å¯¼å‡ºé‡‘é¢æ±‡æ€»Excel"
            },
            en: {
                title: "Integrated Report Extraction Tool",
                subtitle: "Supports Blended Settlement Report and IC++ Report data extraction",
                "section1-title": "Blended Settlement Report Extraction",
                "section2-title": "IC++ Report Extraction",
                step1: "Upload Report files containing blended settlement data (multiple selection allowed)",
                step2: "Click \"Preview Data\" button to view extraction results",
                step3: "Select report type and click \"Export Excel\" button to download consolidated file",
                step4: "Upload Report files containing IC++ settlement data (multiple selection allowed)",
                step5: "Click \"Preview Transactions\" button to view extraction results",
                step6: "Click \"Export Excel\" button to download consolidated file",
                previewGeneralText: "Preview Data",
                downloadGeneralText: "Export Excel",
                resetGeneralText: "Reset Tool",
                previewIcplusText: "Preview Transactions",
                downloadIcplusText: "Export Excel",
                resetIcplusText: "Reset Tool",
                generalSummaryText: "Extracted 0 records",
                icplusSummaryText: "Extracted 0 transaction records",
                footerText: "Integrated Report Extraction Tool Â© 2025",
                noFileAlert: "Please upload report files first",
                noDataAlert: "No data available for export",
                successAlert: "Extracted {count} records in total",
                selectFileText: "Upload Report",
                dragDropText: "Drag & drop files here or click to browse",
                generalReportBtn: "Blended Settlement Report",
                icplusReportBtn: "IC++ Report",
                "tab-transactions-text": "Settlement Transactions Report",
                "tab-amount-text": "Settlement Report Amt Report",
                downloadTransactionsText: "Export Transactions Excel",
                downloadAmountText: "Export Amount Report Excel",
                "icplus-tab-transactions-text": "Settlement Transactions Report",
                "icplus-tab-amount-text": "Settlement Amount Report",
                "downloadIcplusTransactionsText": "Export Transactions Excel",
                "downloadIcplusAmountText": "Export Amount Report Excel"
            }
        };

        // å½“å‰è¯­è¨€å’ŒæŠ¥è¡¨ç±»å‹
        let currentLang = 'zh';
        let currentReportType = 'general';
        let currentTab = 'transactions';
        let currentIcplusTab = 'transactions';
        
        // åˆ‡æ¢è¯­è¨€å‡½æ•°
        function switchLanguage(lang) {
            currentLang = lang;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('lang-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            
            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
            for (const key in translations[lang]) {
                const elements = document.querySelectorAll(`[id="${key}"]`);
                elements.forEach(el => {
                    el.textContent = translations[lang][key];
                });
                
                // ç‰¹æ®Šå¤„ç†æŠ¥è¡¨ç±»å‹æŒ‰é’®
                if (key === 'generalReportBtn') {
                    document.getElementById('type-general').textContent = translations[lang][key];
                }
                if (key === 'icplusReportBtn') {
                    document.getElementById('type-icplus').textContent = translations[lang][key];
                }
                if (key === 'selectFileText') {
                    document.getElementById('generalFileLabel').textContent = translations[lang][key];
                    document.getElementById('icplusFileLabel').textContent = translations[lang][key];
                }
                if (key === 'dragDropText') {
                    document.getElementById('generalFileSmall').textContent = translations[lang][key];
                    document.getElementById('icplusFileSmall').textContent = translations[lang][key];
                }
            }
        }
        
        // åˆ‡æ¢æŠ¥è¡¨ç±»å‹
        function switchReportType(type) {
            currentReportType = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('type-general').classList.toggle('active', type === 'general');
            document.getElementById('type-icplus').classList.toggle('active', type === 'icplus');
            
            // æ˜¾ç¤º/éšè—å¯¹åº”éƒ¨åˆ†
            document.getElementById('general-section').style.display = type === 'general' ? 'block' : 'none';
            document.getElementById('icplus-section').style.display = type === 'icplus' ? 'block' : 'none';
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            currentTab = tabName;

            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}-btn`).classList.add('active');

            // æ›´æ–°æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // åˆ‡æ¢IC++æ ‡ç­¾é¡µ
        function switchIcplusTab(tabName) {
            currentIcplusTab = tabName;

            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#icplusReportTabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`icplus-tab-${tabName}-btn`).classList.add('active');

            // æ›´æ–°æ ‡ç­¾å†…å®¹
            document.querySelectorAll('#icplusReportTabs .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`icplus-tab-${tabName}`).classList.add('active');
        }
        
        // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢å’ŒæŠ¥è¡¨ç±»å‹åˆ‡æ¢
        document.getElementById('lang-zh').addEventListener('click', () => switchLanguage('zh'));
        document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));
        document.getElementById('type-general').addEventListener('click', () => switchReportType('general'));
        document.getElementById('type-icplus').addEventListener('click', () => switchReportType('icplus'));
        
        // ==================== æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ ====================
        
        // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        function initDragDrop() {
            const fileInputAreas = [
                { id: 'generalFileInputArea', inputId: 'generalFileInput', filesDisplayId: 'generalSelectedFiles' },
                { id: 'icplusFileInputArea', inputId: 'icplusFileInput', filesDisplayId: 'icplusSelectedFiles' }
            ];
            
            fileInputAreas.forEach(area => {
                const dropArea = document.getElementById(area.id);
                const fileInput = document.getElementById(area.inputId);
                const filesDisplay = document.getElementById(area.filesDisplayId);
                
                // é˜²æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                // é«˜äº®æ‹–æ‹½åŒºåŸŸ
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                // å¤„ç†æ–‡ä»¶æ”¾ç½®
                dropArea.addEventListener('drop', handleDrop, false);
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                function highlight() {
                    dropArea.classList.add('drag-over');
                }
                
                function unhighlight() {
                    dropArea.classList.remove('drag-over');
                }
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        // åˆ›å»ºæ–°çš„FileListå¯¹è±¡
                        const dataTransfer = new DataTransfer();
                        for (let i = 0; i < files.length; i++) {
                            dataTransfer.items.add(files[i]);
                        }
                        fileInput.files = dataTransfer.files;
                        
                        // æ›´æ–°æ–‡ä»¶æ˜¾ç¤º
                        updateSelectedFiles(fileInput, filesDisplay);
                        
                        // è§¦å‘changeäº‹ä»¶
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);
                    }
                }
                
                // ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–
                fileInput.addEventListener('change', function() {
                    updateSelectedFiles(this, filesDisplay);
                });
            });
        }
        
        // æ›´æ–°é€‰æ‹©çš„æ–‡ä»¶æ˜¾ç¤º
        function updateSelectedFiles(fileInput, filesDisplay) {
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                filesDisplay.textContent = '';
                return;
            }
            
            const fileNames = files.map(file => file.name).join(', ');
            if (files.length === 1) {
                filesDisplay.textContent = currentLang === 'zh' 
                    ? `å·²é€‰æ‹©: ${fileNames}`
                    : `Selected: ${fileNames}`;
            } else {
                filesDisplay.textContent = currentLang === 'zh'
                    ? `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶: ${fileNames.substring(0, 50)}${fileNames.length > 50 ? '...' : ''}`
                    : `Selected ${files.length} files: ${fileNames.substring(0, 50)}${fileNames.length > 50 ? '...' : ''}`;
            }
        }
        
        // ==================== æ•°æ®æ ¼å¼åŒ–å‡½æ•° ====================
        
        /** Excel æ—¥æœŸè½¬æ¢ä¸ºæ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆç”¨äºæ˜¾ç¤ºå’Œå¯¼å‡ºï¼‰ */
        function formatExcelDate(excelDate) {
            if (!excelDate || excelDate === '') return '';
            
            // å¦‚æœæ˜¯æ•°å­—ï¼Œåˆ™æ˜¯Excelæ—¥æœŸæ ¼å¼
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '/');
            }
            
            // å¦‚æœå·²ç»æ˜¯æ—¥æœŸå­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›
            return excelDate;
        }
        
        /** æ ¼å¼åŒ–æ•°å­—ï¼Œä¿ç•™2ä½å°æ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ */
        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return '';
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // ä¿ç•™2ä½å°æ•°
            return num.toFixed(2);
        }
        
        /** æ ¼å¼åŒ–å¤§æ•°å­—ï¼Œæ·»åŠ åƒåˆ†ä½åˆ†éš”ç¬¦ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ */
        function formatLargeNumber(value) {
            if (value === null || value === undefined || value === '') return '';
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // ä¿ç•™2ä½å°æ•°å¹¶æ·»åŠ åƒåˆ†ä½åˆ†éš”ç¬¦
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        /** æ ¼å¼åŒ–æ•°å­—ç”¨äºå¯¼å‡ºï¼Œç¡®ä¿Excelèƒ½è¯†åˆ«ä¸ºæ•°å­— */
        function formatNumberForExport(value) {
            if (value === null || value === undefined || value === '') return '';
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // è¿”å›æ•°å­—ç±»å‹ï¼ŒExcelä¼šè‡ªåŠ¨è¯†åˆ«
            return num;
        }
        
        // ==================== é‡‘é¢æ±‡æ€»ç›¸å…³å‡½æ•° ====================
        
        /** æ¸…ç†æ•°å­—å­—ç¬¦ä¸²ä¸ºçº¯æ•°å­—ï¼ˆç”¨äºå¯¼å‡ºï¼‰ */
        function cleanNumberForExport(value) {
            if (!value && value !== 0) return null;
            
            const strValue = String(value).trim();
            if (strValue === '') return null;
            
            // ç§»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦ï¼ˆä¿ç•™è´Ÿå·å’Œå°æ•°ç‚¹ï¼‰
            const cleanValue = strValue.replace(/[^\d.-]/g, '');
            
            // å¦‚æœæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œè¿”å›null
            if (cleanValue === '' || cleanValue === '-') return null;
            
            // è§£æä¸ºæ•°å€¼
            const num = parseFloat(cleanValue);
            return isNaN(num) ? null : num;
        }
        
        /** ä»å·¥ä½œè¡¨ä¸­æå–ç»“ç®—å•ä¿¡æ¯ï¼ˆç”¨äºé‡‘é¢æ±‡æ€»ï¼‰ */
        function extractInfoFromSheet(sheetData, fileName, sheetName) {
            const infoList = [];
            const baseInfo = {
                settlementId: '',
                capturedPeriod: '',
                walletId: '',
                processingCurrency: '',
                transactionTotalAmount: '',
                settlementCurrency: '',
                settlementTotalAmount: '',
                totalAcquirerFee: '',
                totalNetAmount: '',
                rollingReserveHeld: '',
                rollingReserveReleased: '',
                reserveReleasedPeriod: '',
                wireFee: '',
                otherFee: '',
                grandTotal: '',
                site: '',
                sourceFile: fileName,
                sheetName: sheetName,
                isReserveRelease: false
            };
            
            let foundData = false;
            const reserveReleases = [];
            
            for (let rowIndex = 0; rowIndex < sheetData.length; rowIndex++) {
                const row = sheetData[rowIndex];
                if (!row || row.length === 0) continue;
                
                for (let colIndex = 0; colIndex < row.length; colIndex++) {
                    const cell = row[colIndex];
                    const cellStr = String(cell).trim();
                    
                    if (!cellStr) continue;
                    
                    // 1. æå–Settlement ID
                    if (cellStr.includes('Settlement ID:')) {
                        const match = cellStr.match(/Settlement ID:\s*([^\s]+)/i);
                        if (match && match[1]) {
                            baseInfo.settlementId = match[1].trim();
                            foundData = true;
                        } else {
                            if (colIndex + 1 < row.length) {
                                const nextCell = row[colIndex + 1];
                                if (nextCell && String(nextCell).trim()) {
                                    baseInfo.settlementId = String(nextCell).trim();
                                    foundData = true;
                                }
                            }
                        }
                    }
                    
                    // 2. æå–Captured Period
                    if (cellStr.includes('Captured Period:')) {
                        const match = cellStr.match(/Captured Period:\s*(.+)/i);
                        if (match && match[1]) {
                            let dateStr = match[1].trim();
                            dateStr = dateStr.replace(/\s\d{2}:\d{2}/g, '');
                            baseInfo.capturedPeriod = dateStr;
                            foundData = true;
                        } else {
                            if (colIndex + 1 < row.length) {
                                const nextCell = row[colIndex + 1];
                                if (nextCell && String(nextCell).trim()) {
                                    let dateStr = String(nextCell).trim();
                                    dateStr = dateStr.replace(/\s\d{2}:\d{2}/g, '');
                                    baseInfo.capturedPeriod = dateStr;
                                    foundData = true;
                                }
                            }
                        }
                    }
                    
                    // 3. æå–Wallet ID
                    if (cellStr.includes('Wallet ID:')) {
                        if (colIndex + 1 < row.length) {
                            const nextCell = row[colIndex + 1];
                            if (nextCell && String(nextCell).trim()) {
                                baseInfo.walletId = String(nextCell).trim();
                                foundData = true;
                            }
                        }
                    }
                    
                    // 4. æå–Processing Currency
                    if (cellStr.includes('Processing Currency:')) {
                        const match = cellStr.match(/Processing Currency:\s*([^\s]+)/i);
                        if (match && match[1]) {
                            baseInfo.processingCurrency = match[1].trim();
                            foundData = true;
                        } else {
                            if (colIndex + 1 < row.length) {
                                const nextCell = row[colIndex + 1];
                                if (nextCell && String(nextCell).trim()) {
                                    baseInfo.processingCurrency = String(nextCell).trim();
                                    foundData = true;
                                }
                            }
                        }
                    }
                    
                    // 5. æå–TRANSACTION TOTAL AMOUNT
                    if (cellStr.includes('TRANSACTION TOTAL AMOUNT')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.transactionTotalAmount = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 6. æå–Settlement Currency
                    if (cellStr.includes('Settlement Currency:')) {
                        const match = cellStr.match(/Settlement Currency:\s*([^\s]+)/i);
                        if (match && match[1]) {
                            baseInfo.settlementCurrency = match[1].trim();
                            foundData = true;
                        } else {
                            if (colIndex + 1 < row.length) {
                                const nextCell = row[colIndex + 1];
                                if (nextCell && String(nextCell).trim()) {
                                    baseInfo.settlementCurrency = String(nextCell).trim();
                                    foundData = true;
                                }
                            }
                        }
                    }
                    
                    // 7. æå–SETTLEMENT TOTAL AMOUNT
                    if (cellStr.includes('SETTLEMENT TOTAL AMOUNT')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.settlementTotalAmount = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 8. æå–TOTAL ACQUIRER FEE
                    if (cellStr.includes('TOTAL ACQUIRER FEE')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.totalAcquirerFee = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 9. æå–TOTAL NET AMOUNT
                    if (cellStr.includes('TOTAL NET AMOUNT')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.totalNetAmount = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 10. æå–Rolling Reserve held
                    if (cellStr.includes('Rolling Reserve held')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.rollingReserveHeld = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 11. æå–Rolling Reserve released
                    if (cellStr.includes('Rolling Reserve released')) {
                        let releaseAmount = '';
                        let releasePeriod = '';
                        
                        // æå–é‡‘é¢
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                releaseAmount = cellValue;
                                break;
                            }
                        }
                        
                        // æå–æœŸé—´
                        const datePattern = /\d{1,2}\.\d{1,2}\.\d{2,4}\s*-\s*\d{1,2}\.\d{1,2}\.\d{2,4}/;
                        const match = cellStr.match(datePattern);
                        if (match) {
                            releasePeriod = match[0];
                        }
                        
                        // å¦‚æœæœ‰æœ‰æ•ˆçš„é‡Šæ”¾è®°å½•ï¼Œæ·»åŠ åˆ°æ•°ç»„ä¸­
                        if (releaseAmount || releasePeriod) {
                            reserveReleases.push({
                                amount: releaseAmount,
                                period: releasePeriod
                            });
                            foundData = true;
                        }
                    }
                    
                    // 12. æå–Wire fee
                    if (cellStr.toLowerCase().includes('wire fee') || cellStr.toLowerCase().includes('wire transfer fee')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.wireFee = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 13. æå–Correction
                    if (cellStr.includes('Correction')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.otherFee = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 14. æå–GRAND TOTAL
                    if (cellStr.includes('GRAND TOTAL')) {
                        for (let i = colIndex + 1; i < row.length; i++) {
                            const valueCell = row[i];
                            if (valueCell !== null && valueCell !== undefined && valueCell !== '') {
                                const cellValue = String(valueCell).trim();
                                baseInfo.grandTotal = cellValue;
                                foundData = true;
                                break;
                            }
                        }
                    }
                    
                    // 15. æå–Siteä¿¡æ¯
                    if (cellStr.includes('Site:')) {
                        const match = cellStr.match(/Site:\s*(.+)/i);
                        if (match && match[1]) {
                            baseInfo.site = match[1].trim();
                            foundData = true;
                        } else {
                            if (colIndex + 1 < row.length) {
                                const nextCell = row[colIndex + 1];
                                if (nextCell && String(nextCell).trim()) {
                                    baseInfo.site = String(nextCell).trim();
                                    foundData = true;
                                }
                            }
                        }
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ•°æ®ï¼Œè¿”å›null
            if (!foundData) {
                return null;
            }
            
            // å¦‚æœæ²¡æœ‰é‡Šæ”¾çš„ä¿è¯é‡‘è®°å½•ï¼Œåªæ·»åŠ åŸºç¡€è®°å½•
            if (reserveReleases.length === 0) {
                infoList.push({...baseInfo});
            } else {
                // é¦–å…ˆæ·»åŠ åŸºç¡€è®°å½•ï¼ˆç¬¬ä¸€æ¡è®°å½•åŒ…å«æ‰€æœ‰ä¿¡æ¯ï¼‰
                const firstRelease = reserveReleases[0];
                const baseRecord = {...baseInfo};
                baseRecord.rollingReserveReleased = firstRelease.amount;
                baseRecord.reserveReleasedPeriod = firstRelease.period;
                infoList.push(baseRecord);
                
                // ä¸ºå…¶ä»–é‡Šæ”¾è®°å½•æ·»åŠ ç‹¬ç«‹è¡Œ
                for (let i = 1; i < reserveReleases.length; i++) {
                    const reserveRelease = reserveReleases[i];
                    const reserveRecord = {
                        ...baseInfo,
                        rollingReserveReleased: reserveRelease.amount,
                        reserveReleasedPeriod: reserveRelease.period,
                        isReserveRelease: true,
                        // è¿™äº›å­—æ®µåœ¨é‡Šæ”¾è®°å½•è¡Œä¸­ç•™ç©º
                        grandTotal: '',
                        settlementCurrency: '',
                        settlementTotalAmount: '',
                        totalAcquirerFee: '',
                        totalNetAmount: '',
                        transactionTotalAmount: '',
                        rollingReserveHeld: '',
                        wireFee: '',
                        otherFee: ''
                    };
                    infoList.push(reserveRecord);
                }
            }
            
            return infoList;
        }
        
        // ==================== General Report Functions ====================
        
        let gGeneralRows = []; // ä¿å­˜é€šç”¨æŠ¥è¡¨æ•°æ®
        let gGeneralHeaders = []; // ä¿å­˜é€šç”¨æŠ¥è¡¨è¡¨å¤´
        let gAmountData = []; // ä¿å­˜é‡‘é¢æ±‡æ€»æ•°æ®

        // IC++ é‡‘é¢æ±‡æ€»æ•°æ®
        let gIcplusAmountData = []; // ä¿å­˜IC++é‡‘é¢æ±‡æ€»æ•°æ®
        
        /* ---------- é€šç”¨æŠ¥è¡¨é¢„è§ˆ ---------- */
        async function previewGeneralData() {
            const files = Array.from(document.getElementById('generalFileInput').files);
            if(!files.length){
                alert(currentLang === 'zh' ? 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶' : 'Please upload report files first');
                return;
            }

            // é‡ç½®æ•°æ®
            gGeneralRows = [];
            gAmountData = [];
            const tbody = document.querySelector('#generalTableBody');
            tbody.innerHTML = '';
            const amountTbody = document.querySelector('#amountTableBody');
            amountTbody.innerHTML = '';

            let processedCount = 0;
            let totalRecords = 0;
            let amountRecords = 0;

            for (const file of files){
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const allRows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    // ===== æå–äº¤æ˜“æ•°æ®ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰ =====
                    // æå– Meta ä¸ Fee Meta
                    const meta = extractMeta(allRows);
                    const feeMeta = extractFee(allRows);
                    
                    // æ‰¾åˆ°æ•°æ®å¼€å§‹è¡Œ
                    const startIndex = allRows.findIndex(row => row.includes("Order ID"));
                    if (startIndex === -1) {
                        console.warn(currentLang === 'zh' ? 'æœªæ‰¾åˆ°æ•°æ®å¼€å§‹è¡Œ:' : 'Data start row not found:', file.name);
                    } else {
                        const cleanRows = allRows.slice(startIndex);
                        const rawHeaderRow = cleanRows[0].filter(v => v !== "");
                        const emptyIndexes = cleanRows[0].map((h, i) => h === "" ? i : -1).filter(i => i !== -1);
                        
                        // æ„å»ºå®Œæ•´è¡¨å¤´
                        const fullHeaderRow = [...rawHeaderRow, ...Object.keys(meta), ...Object.keys(feeMeta)];
                        
                        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œè®¾ç½®è¡¨å¤´
                        if (processedCount === 0) {
                            gGeneralHeaders = fullHeaderRow;
                            const headerRow = document.createElement('tr');
                            fullHeaderRow.forEach(header => {
                                const th = document.createElement('th');
                                th.textContent = header;
                                headerRow.appendChild(th);
                            });
                            document.getElementById('generalTableHeader').innerHTML = '';
                            document.getElementById('generalTableHeader').appendChild(headerRow);
                        }
                        
                        // å¤„ç†æ•°æ®è¡Œ
                        const dataRows = allRows.slice(startIndex + 1);
                        
                        dataRows.forEach((row, r) => {
                            // åªç§»é™¤ç©º header å¯¹åº”æ ä½ï¼Œä¿ç•™å…¶ä»–ç©ºå€¼
                            const filteredRow = row.filter((v, idx) => !emptyIndexes.includes(idx));
                            
                            // æ—¥æœŸè½¬æ¢
                            const dateColumnsToConvert = ["Date"];
                            const dateColIndexes = dateColumnsToConvert.map(col => fullHeaderRow.indexOf(col)).filter(i => i !== -1);
                            
                            dateColIndexes.forEach(idx => {
                                if (typeof filteredRow[idx] === "number") {
                                    filteredRow[idx] = formatExcelDate(filteredRow[idx]);
                                }
                            });
                            
                            // åªåœ¨ç¬¬ä¸€ç¬”èµ„æ–™åŠ å…¥ Meta ä¸ Fee Meta
                            const fullRow = [
                                ...filteredRow,
                                ...(r === 0 ? Object.keys(meta).map(k => meta[k]) : []),
                                ...(r === 0 ? Object.keys(feeMeta).map(k => feeMeta[k] || "") : [])
                            ];
                            
                            gGeneralRows.push(fullRow);
                            totalRecords++;

                            const tr = document.createElement('tr');
                            fullRow.forEach(v => {
                                const td = document.createElement('td');
                                td.textContent = v;
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                    }
                    
                    // ===== æå–é‡‘é¢æ±‡æ€»æ•°æ®ï¼ˆæ–°åŠŸèƒ½ï¼‰ =====
                    for (let sheetIndex = 0; sheetIndex < workbook.SheetNames.length; sheetIndex++) {
                        const sheetName = workbook.SheetNames[sheetIndex];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSONæ•°ç»„
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                        
                        // ä»å·¥ä½œè¡¨æ•°æ®ä¸­æå–ä¿¡æ¯
                        const sheetInfoList = extractInfoFromSheet(jsonData, file.name, sheetName);
                        if (sheetInfoList && sheetInfoList.length > 0) {
                            gAmountData.push(...sheetInfoList);
                            amountRecords += sheetInfoList.length;
                        }
                    }
                    
                    processedCount++;
                    
                } catch (e) {
                    console.error(currentLang === 'zh' ? 'å¤„ç†æ–‡ä»¶å‡ºé”™:' : 'Error processing file:', file.name, e);
                }
            }

            // æ˜¾ç¤ºé‡‘é¢æ±‡æ€»è¡¨æ ¼
            if (gAmountData.length > 0) {
                displayAmountTable();
                document.getElementById('amountTableContainer').style.display = 'block';
                document.getElementById('amountPreviewTable').style.display = 'table';
            }

            // æ˜¾ç¤ºäº¤æ˜“æ•°æ®è¡¨æ ¼
            if (gGeneralRows.length > 0) {
                document.getElementById('generalTableContainer').style.display = 'block';
                document.getElementById('generalPreviewTable').style.display = 'table';
            }

            // æ˜¾ç¤ºæ ‡ç­¾é¡µå®¹å™¨
            document.getElementById('reportTabs').style.display = 'block';
            
            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            const summaryText = currentLang === 'zh' ? 
                `å·²æå– ${totalRecords} æ¡äº¤æ˜“è®°å½•ï¼Œ${amountRecords} æ¡é‡‘é¢è®°å½•` : 
                `Extracted ${totalRecords} transaction records, ${amountRecords} amount records`;
            document.getElementById('generalSummaryText').textContent = summaryText;
            document.getElementById('generalSummary').style.display = 'block';
            
            // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            document.getElementById('downloadGeneralBtn').style.display = 'block';
            document.getElementById('downloadTransactionsBtn').style.display = 'block';
            document.getElementById('downloadAmountBtn').style.display = 'block';
            
            alert((currentLang === 'zh' ? 'å…±æå–äº† ' : 'Extracted ') + totalRecords + 
                  (currentLang === 'zh' ? ' æ¡äº¤æ˜“è®°å½•å’Œ ' : ' transaction records and ') + 
                  amountRecords + (currentLang === 'zh' ? ' æ¡é‡‘é¢è®°å½•' : ' amount records'));
        }
        
        /* ---------- æ˜¾ç¤ºé‡‘é¢æ±‡æ€»è¡¨æ ¼ ---------- */
        function displayAmountTable() {
            const amountTbody = document.querySelector('#amountTableBody');
            amountTbody.innerHTML = '';
            
            gAmountData.forEach((rowData, index) => {
                const row = document.createElement('tr');
                
                // å¦‚æœæ˜¯ä¿è¯é‡‘é‡Šæ”¾è®°å½•è¡Œï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (rowData.isReserveRelease) {
                    row.className = 'reserve-row';
                }
                
                // Settlement ID - ç¬¬ä¸€åˆ—
                const td1 = document.createElement('td');
                td1.textContent = rowData.settlementId || '';
                row.appendChild(td1);
                
                // Processing Period - ç¬¬äºŒåˆ—
                const td2 = document.createElement('td');
                td2.textContent = rowData.capturedPeriod || '';
                row.appendChild(td2);
                
                // Wallet ID - ç¬¬ä¸‰åˆ—
                const td3 = document.createElement('td');
                td3.textContent = rowData.walletId || '';
                row.appendChild(td3);
                
                // Processing Currency - ç¬¬å››åˆ—
                const td4 = document.createElement('td');
                td4.textContent = rowData.processingCurrency || '';
                row.appendChild(td4);
                
                // TRANSACTION TOTAL AMOUNT - é‡‘é¢æ ¼å¼ - ç¬¬äº”åˆ—
                const td5 = document.createElement('td');
                td5.className = 'amount-cell';
                td5.textContent = formatLargeNumber(rowData.transactionTotalAmount) || '';
                row.appendChild(td5);
                
                // Settlement Currency - ç¬¬å…­åˆ—
                const td6 = document.createElement('td');
                td6.textContent = rowData.settlementCurrency || '';
                row.appendChild(td6);
                
                // SETTLEMENT TOTAL AMOUNT - é‡‘é¢æ ¼å¼ - ç¬¬ä¸ƒåˆ—
                const td7 = document.createElement('td');
                td7.className = 'amount-cell';
                td7.textContent = formatLargeNumber(rowData.settlementTotalAmount) || '';
                row.appendChild(td7);
                
                // TOTAL ACQUIRER FEE - é‡‘é¢æ ¼å¼ - ç¬¬å…«åˆ—
                const td8 = document.createElement('td');
                td8.className = 'amount-cell';
                td8.textContent = formatLargeNumber(rowData.totalAcquirerFee) || '';
                row.appendChild(td8);
                
                // TOTAL NET AMOUNT - é‡‘é¢æ ¼å¼ - ç¬¬ä¹åˆ—
                const td9 = document.createElement('td');
                td9.className = 'amount-cell';
                td9.textContent = formatLargeNumber(rowData.totalNetAmount) || '';
                row.appendChild(td9);
                
                // Rolling Reserve held - é‡‘é¢æ ¼å¼ - ç¬¬ååˆ—
                const td10 = document.createElement('td');
                td10.className = 'amount-cell';
                td10.textContent = formatLargeNumber(rowData.rollingReserveHeld) || '';
                row.appendChild(td10);
                
                // Rolling Reserve released - é‡‘é¢æ ¼å¼ - ç¬¬åä¸€åˆ—
                const td11 = document.createElement('td');
                td11.className = 'amount-cell';
                td11.textContent = formatLargeNumber(rowData.rollingReserveReleased) || '';
                row.appendChild(td11);
                
                // Rolling Reserve released Period - ç¬¬åäºŒåˆ—
                const td12 = document.createElement('td');
                td12.textContent = rowData.reserveReleasedPeriod || '';
                row.appendChild(td12);
                
                // Wire fee - é‡‘é¢æ ¼å¼ - ç¬¬åä¸‰åˆ—
                const td13 = document.createElement('td');
                td13.className = 'amount-cell';
                td13.textContent = formatLargeNumber(rowData.wireFee) || '';
                row.appendChild(td13);
                
                // Other - é‡‘é¢æ ¼å¼ - ç¬¬åå››åˆ—
                const td14 = document.createElement('td');
                td14.className = 'amount-cell';
                td14.textContent = formatLargeNumber(rowData.otherFee) || '';
                row.appendChild(td14);
                
                // GRAND TOTAL - é‡‘é¢æ ¼å¼ - ç¬¬åäº”åˆ—
                const td15 = document.createElement('td');
                td15.className = 'amount-cell';
                td15.textContent = formatLargeNumber(rowData.grandTotal) || '';
                row.appendChild(td15);
                
                // Site - ç¬¬åå…­åˆ—
                const td16 = document.createElement('td');
                td16.textContent = rowData.site || '';
                td16.className = 'site-cell';
                row.appendChild(td16);
                
                // Source File - ç¬¬åä¸ƒåˆ—
                const td17 = document.createElement('td');
                td17.textContent = rowData.sourceFile || '';
                td17.style.whiteSpace = 'normal';
                td17.style.maxWidth = '200px';
                td17.style.wordBreak = 'break-all';
                row.appendChild(td17);
                
                amountTbody.appendChild(row);
            });
        }
        
        /* ---------- é€šç”¨æŠ¥è¡¨å¯¼å‡ºï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰ ---------- */
        function downloadGeneralExcel() {
            // æ ¹æ®å½“å‰æ ‡ç­¾é¡µå†³å®šå¯¼å‡ºå“ªä¸ªæŠ¥è¡¨
            if (currentTab === 'transactions') {
                downloadTransactionsExcel();
            } else {
                downloadAmountExcel();
            }
        }
        
        /* ---------- å¯¼å‡ºäº¤æ˜“æ±‡æ€» Excel ---------- */
        function downloadTransactionsExcel() {
            if(!gGeneralRows.length){
                alert(currentLang === 'zh' ? 'æ²¡æœ‰å¯å¯¼å‡ºçš„äº¤æ˜“æ•°æ®' : 'No transaction data available for export');
                return;
            }
            
            // åˆ›å»ºå·¥ä½œè¡¨æ•°æ® - ä½¿ç”¨é¢„è§ˆæ—¶å·²ç»æ ¼å¼åŒ–çš„æ•°æ®
            const ws_data = [gGeneralHeaders];
            
            // æ·»åŠ å·²ç»æ ¼å¼åŒ–å¥½çš„æ•°æ®è¡Œ
            ws_data.push(...gGeneralRows);
            
            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Blended Report');
            
            // å†™å…¥æ–‡ä»¶
            XLSX.writeFile(wb, "blended_report_transactions.xlsx");
        }
        
        /* ---------- å¯¼å‡ºé‡‘é¢æ±‡æ€» Excel ---------- */
        function downloadAmountExcel() {
            if(!gAmountData.length){
                alert(currentLang === 'zh' ? 'æ²¡æœ‰å¯å¯¼å‡ºçš„é‡‘é¢æ•°æ®' : 'No amount data available for export');
                return;
            }
            
            try {
                // å‡†å¤‡å·¥ä½œè¡¨æ•°æ®
                const worksheetData = [
                    // è¡¨å¤´
                    [
                        'Settlement ID', 
                        'Processing Period',
                        'Wallet ID',
                        'Processing Currency',
                        'TRANSACTION TOTAL AMOUNT',
                        'Settlement Currency',
                        'SETTLEMENT TOTAL AMOUNT',
                        'TOTAL ACQUIRER FEE',
                        'TOTAL NET AMOUNT',
                        'Rolling Reserve held',
                        'Rolling Reserve released',
                        'Rolling Reserve released Period',
                        'Wire fee',
                        'Other',
                        'GRAND TOTAL',
                        'Site',
                        'Source File'
                    ]
                ];
                
                // æ·»åŠ æ•°æ®è¡Œ - ä½¿ç”¨æ¸…ç†åçš„æ•°å­—ï¼ˆæ•°å€¼æ ¼å¼ï¼‰
                gAmountData.forEach(item => {
                    worksheetData.push([
                        item.settlementId || '',
                        item.capturedPeriod || '',
                        item.walletId || '',
                        item.processingCurrency || '',
                        cleanNumberForExport(item.transactionTotalAmount),
                        item.settlementCurrency || '',
                        cleanNumberForExport(item.settlementTotalAmount),
                        cleanNumberForExport(item.totalAcquirerFee),
                        cleanNumberForExport(item.totalNetAmount),
                        cleanNumberForExport(item.rollingReserveHeld),
                        cleanNumberForExport(item.rollingReserveReleased),
                        item.reserveReleasedPeriod || '',
                        cleanNumberForExport(item.wireFee),
                        cleanNumberForExport(item.otherFee),
                        cleanNumberForExport(item.grandTotal),
                        item.site || '',
                        item.sourceFile || ''
                    ]);
                });
                
                // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // å®šä¹‰æ•°å­—åˆ—ï¼ˆé‡‘é¢åˆ—ï¼‰çš„ç´¢å¼•
                const numberColumns = [4, 6, 7, 8, 9, 10, 12, 13, 14]; // åŸºäº0çš„ç´¢å¼•
                
                // ä¸ºæ•°å­—åˆ—è®¾ç½®å•å…ƒæ ¼æ ¼å¼
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let row = range.s.r + 1; row <= range.e.r; row++) {
                    for (const col of numberColumns) {
                        const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                        const cell = worksheet[cellAddress];
                        
                        if (cell && cell.v !== null && cell.v !== '') {
                            // è®¾ç½®å•å…ƒæ ¼ç±»å‹ä¸ºæ•°å­—
                            cell.t = 'n'; // nè¡¨ç¤ºæ•°å­—ç±»å‹
                            
                            // è®¾ç½®å•å…ƒæ ¼æ ¼å¼ä¸ºä¼šè®¡æ ¼å¼ï¼ˆå¸¦åƒä½åˆ†éš”ç¬¦ï¼Œ2ä½å°æ•°ï¼‰
                            cell.z = '#,##0.00';
                            
                            // å¯¹äºè´Ÿå€¼ï¼Œè®¾ç½®çº¢è‰²æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
                            if (cell.v < 0) {
                                cell.s = {
                                    font: { color: { rgb: "FF0000" } }
                                };
                            }
                        }
                    }
                }
                
                // è®¾ç½®åˆ—å®½
                const colWidths = [
                    { wch: 15 },  // Settlement ID
                    { wch: 30 },  // Processing Period
                    { wch: 15 },  // Wallet ID
                    { wch: 15 },  // Processing Currency
                    { wch: 20 },  // TRANSACTION TOTAL AMOUNT
                    { wch: 15 },  // Settlement Currency
                    { wch: 20 },  // SETTLEMENT TOTAL AMOUNT
                    { wch: 18 },  // TOTAL ACQUIRER FEE
                    { wch: 15 },  // TOTAL NET AMOUNT
                    { wch: 20 },  // Rolling Reserve held
                    { wch: 20 },  // Rolling Reserve released
                    { wch: 30 },  // Rolling Reserve released Period
                    { wch: 12 },  // Wire fee
                    { wch: 12 },  // Other
                    { wch: 15 },  // GRAND TOTAL
                    { wch: 25 },  // Site
                    { wch: 30 }   // Source File
                ];
                
                worksheet['!cols'] = colWidths;
                
                // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(workbook, worksheet, 'ç»“ç®—å•ä¿¡æ¯');
                
                // ç”Ÿæˆæ–‡ä»¶å
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `ç»“ç®—å•é‡‘é¢æ±‡æ€»_${dateStr}_${gAmountData.length}æ¡è®°å½•.xlsx`;
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(workbook, fileName);
                
                alert(currentLang === 'zh' ? 
                    `æ–‡ä»¶å·²å¯¼å‡º: ${fileName}ï¼ŒåŒ…å« ${gAmountData.length} æ¡è®°å½•ï¼Œæ•°å­—å·²æ­£ç¡®æ ¼å¼åŒ–ä¸ºæ•°å€¼ç±»å‹` :
                    `File exported: ${fileName}, containing ${gAmountData.length} records, numbers formatted as numeric type`);
            } catch (error) {
                console.error(currentLang === 'zh' ? 'å¯¼å‡ºExcelæ—¶å‡ºé”™:' : 'Error exporting Excel:', error);
                alert(currentLang === 'zh' ? `å¯¼å‡ºExcelæ—¶å‡ºé”™: ${error.message}` : `Error exporting Excel: ${error.message}`);
            }
        }
        
        /* ---------- é€šç”¨æŠ¥è¡¨é‡ç½® ---------- */
        function resetGeneralTool() {
            document.getElementById('generalFileInput').value = '';
            document.getElementById('generalSelectedFiles').textContent = '';
            document.getElementById('generalTableBody').innerHTML = '';
            document.getElementById('generalTableHeader').innerHTML = '';
            document.getElementById('amountTableBody').innerHTML = '';
            document.getElementById('generalTableContainer').style.display = 'none';
            document.getElementById('generalPreviewTable').style.display = 'none';
            document.getElementById('amountTableContainer').style.display = 'none';
            document.getElementById('amountPreviewTable').style.display = 'none';
            document.getElementById('reportTabs').style.display = 'none';
            document.getElementById('downloadGeneralBtn').style.display = 'none';
            document.getElementById('downloadTransactionsBtn').style.display = 'none';
            document.getElementById('downloadAmountBtn').style.display = 'none';
            document.getElementById('generalSummary').style.display = 'none';
            gGeneralRows = [];
            gGeneralHeaders = [];
            gAmountData = [];
        }
        
        // ==================== IC++ Report Functions ====================

        let gTransactionFormattedRows = []; // ä¿å­˜æ ¼å¼åŒ–åçš„äº¤æ˜“ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºå’Œå¯¼å‡ºï¼‰

        // ==================== IC++ é‡‘é¢æ±‡æ€»ç›¸å…³å‡½æ•° ====================

        /** ä»æ–‡ä»¶åæå–Settlement ID */
        function extractSettlementIdFromFileName(fileName) {
            const parts = fileName.split('_');
            if (parts.length >= 7) {
                return parts[parts.length - 2];
            }

            const match = fileName.match(/(\d{10,})/);
            return match ? match[1] : '';
        }

        /** æ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸²ï¼Œç§»é™¤æ—¶é—´éƒ¨åˆ† */
        function formatDateWithoutTime(dateStr) {
            if (!dateStr) return '';
            const withoutTime = dateStr.replace(/\s\d{2}:\d{2}/g, '');
            return withoutTime.trim();
        }

        /** æå–ç»“ç®—æ—¥æœŸï¼ˆæ ¼å¼ï¼šdd.mm.yyyyï¼‰ */
        function extractSettlementDate(dateStr) {
            if (!dateStr) return '';
            const match = dateStr.match(/(\d{1,2}\.\d{1,2}\.\d{4})/);
            return match ? match[1] : '';
        }

        /** æ ¼å¼åŒ–ç™¾åˆ†æ¯”ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ */
        function formatPercentForDisplay(value) {
            if (!value && value !== 0) return '';

            const strValue = String(value).trim();
            const cleanValue = strValue.replace(/[^\d.-]/g, '');
            const num = parseFloat(cleanValue);

            if (isNaN(num)) return strValue;

            const percent = num * 100;
            return `${percent}%`;
        }

        /** æ¸…ç†ç™¾åˆ†æ¯”å­—ç¬¦ä¸²ä¸ºå°æ•°ï¼ˆç”¨äºå¯¼å‡ºï¼‰ */
        function cleanPercentForExport(value) {
            if (!value && value !== 0) return null;

            const strValue = String(value).trim();
            if (strValue === '') return null;

            const cleanValue = strValue.replace(/[^\d.-]/g, '');
            if (cleanValue === '' || cleanValue === '-') return null;

            const num = parseFloat(cleanValue);

            if (isNaN(num)) return null;

            if (num > 1) {
                return num / 100;
            }

            return num;
        }

        /** ä»IC++å·¥ä½œè¡¨ä¸­æå–ç»“ç®—å•ä¿¡æ¯ï¼ˆç”¨äºé‡‘é¢æ±‡æ€»ï¼‰ */
        function extractIcplusInfoFromSheet(sheetData, fileName, sheetName) {
            const settlementId = extractSettlementIdFromFileName(fileName);

            const baseInfo = {
                settlementId: settlementId || '',
                settlementDate: '',
                capturedPeriod: '',
                walletId: '',
                processingCurrency: '',
                transactionAmount: '',
                settlementCurrency: '',
                settlementAmount: '',
                interchangeFee: '',
                schemeFee: '',
                acquirerFee: '',
                totalNetAmount: '',
                rrPercent: '',
                rollingReserveHeld: '',
                rollingReserveReleased: '',
                reserveReleasedPeriod: '',
                wireFee: '',
                otherFee: '',
                grandTotal: '',
                site: '',
                sourceFile: fileName,
                sheetName: sheetName
            };

            let foundData = false;

            // éå†æ‰€æœ‰è¡Œæå–ä¿¡æ¯
            for (let rowIndex = 0; rowIndex < sheetData.length; rowIndex++) {
                const row = sheetData[rowIndex];
                if (!row || row.length === 0) continue;

                // é€å•å…ƒæ ¼æ£€æŸ¥
                for (let colIndex = 0; colIndex < row.length; colIndex++) {
                    const cell = row[colIndex];
                    const cellStr = String(cell).trim();

                    if (!cellStr) continue;

                    // æå–Settlement Date
                    if (cellStr.includes('Settlement Date:')) {
                        const match = cellStr.match(/Settlement Date:\s*([^\s]+)/i);
                        if (match && match[1]) {
                            baseInfo.settlementDate = extractSettlementDate(match[1].trim());
                            foundData = true;
                        }
                    }

                    // æå–Processing Period
                    if (cellStr.includes('Processing Period:')) {
                        const match = cellStr.match(/Processing Period:\s*(.+)/i);
                        if (match && match[1]) {
                            baseInfo.capturedPeriod = formatDateWithoutTime(match[1].trim());
                            foundData = true;
                        }
                    }

                    // æå–Wallet ID
                    if (cellStr.includes('Wallet ID:')) {
                        if (colIndex + 1 < row.length && row[colIndex + 1]) {
                            baseInfo.walletId = String(row[colIndex + 1]).trim();
                            foundData = true;
                        }
                    }

                    // æå–Processing Currency - ä¿æŒåŸå€¼ï¼ˆå¤§å†™ï¼‰
                    if (cellStr.includes('Processing Currency:')) {
                        const match = cellStr.match(/Processing Currency:\s*([^\s]+)/i);
                        if (match && match[1]) {
                            baseInfo.processingCurrency = match[1].trim();
                            foundData = true;
                        }
                    }

                    // æå–Settlement Currency - ä¿æŒåŸå€¼ï¼ˆå¤§å†™ï¼‰
                    if (cellStr.includes('Settlement Currency:')) {
                        const match = cellStr.match(/Settlement Currency:\s*([^\s]+)/i);
                        if (match && match[1]) {
                            baseInfo.settlementCurrency = match[1].trim();
                            foundData = true;
                        }
                    }

                    // æå–Site
                    if (cellStr.includes('Site:')) {
                        const match = cellStr.match(/Site:\s*(.+)/i);
                        if (match && match[1]) {
                            baseInfo.site = match[1].trim();
                            foundData = true;
                        }
                    }
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºTotalè¡Œï¼ˆä½¿ç”¨ä¸åŒºåˆ†å¤§å°å†™çš„æ¯”è¾ƒï¼‰
                const rowStr = row.join(' ').toLowerCase();

                // æŸ¥æ‰¾Totalè¡Œ
                if (rowStr.includes('total') && !rowStr.includes('grand total') && row.length > 10) {
                    // Transaction Amount (Gåˆ—ï¼Œç´¢å¼•6)
                    if (row.length > 6 && row[6] !== '' && row[6] !== null) {
                        baseInfo.transactionAmount = String(row[6]).trim();
                    }

                    // Settlement Amount (Iåˆ—ï¼Œç´¢å¼•8)
                    if (row.length > 8 && row[8] !== '' && row[8] !== null) {
                        baseInfo.settlementAmount = String(row[8]).trim();
                    }

                    // Settlement Currency (Jåˆ—ï¼Œç´¢å¼•9)
                    if (row.length > 9 && row[9] !== '' && row[9] !== null) {
                        baseInfo.settlementCurrency = String(row[9]).trim();
                    }

                    // Interchange Fee (Kåˆ—ï¼Œç´¢å¼•10)
                    if (row.length > 10 && row[10] !== '' && row[10] !== null) {
                        baseInfo.interchangeFee = String(row[10]).trim();
                    }

                    // Scheme Fee (Låˆ—ï¼Œç´¢å¼•11)
                    if (row.length > 11 && row[11] !== '' && row[11] !== null) {
                        baseInfo.schemeFee = String(row[11]).trim();
                    }

                    // Acquirer Fee (Måˆ—ï¼Œç´¢å¼•12)
                    if (row.length > 12 && row[12] !== '' && row[12] !== null) {
                        baseInfo.acquirerFee = String(row[12]).trim();
                    }

                    // TOTAL NET AMOUNT (Oåˆ—ï¼Œç´¢å¼•14)
                    if (row.length > 14 && row[14] !== '' && row[14] !== null) {
                        baseInfo.totalNetAmount = String(row[14]).trim();
                    }

                    foundData = true;
                }

                // æŸ¥æ‰¾Rolling Reserveè¡Œ
                if (rowStr.includes('rolling reserve') && !rowStr.includes('release')) {
                    // RRæ¯”ä¾‹ (Fåˆ—ï¼Œç´¢å¼•5)
                    if (row.length > 5 && row[5] !== '' && row[5] !== null) {
                        baseInfo.rrPercent = String(row[5]).trim();
                    }

                    // Rolling Reserve heldé‡‘é¢ (Oåˆ—ï¼Œç´¢å¼•14)
                    if (row.length > 14 && row[14] !== '' && row[14] !== null) {
                        baseInfo.rollingReserveHeld = String(row[14]).trim();
                    }

                    foundData = true;
                }

                // æŸ¥æ‰¾Release rolling reserveè¡Œ - ä¼˜åŒ–è¯†åˆ«
                if (rowStr.includes('release rolling reserve') ||
                    (row[4] && String(row[4]).toLowerCase().includes('release rolling reserve'))) {

                    // Releaseé‡‘é¢ (Oåˆ—ï¼Œç´¢å¼•14)
                    if (row.length > 14 && row[14] !== '' && row[14] !== null) {
                        baseInfo.rollingReserveReleased = String(row[14]).trim();
                    }

                    // æå–æœŸé—´ - ç›´æ¥ä»åŒ…å«æ—¥æœŸçš„æ–‡æœ¬ä¸­æå–
                    for (let i = 0; i < row.length; i++) {
                        const cellText = String(row[i] || '');
                        const datePattern = /\d{1,2}\.\d{1,2}\.\d{4}\s*\d{2}:\d{2}\s*-\s*\d{1,2}\.\d{1,2}\.\d{4}\s*\d{2}:\d{2}/;
                        const match = cellText.match(datePattern);
                        if (match) {
                            baseInfo.reserveReleasedPeriod = formatDateWithoutTime(match[0]);
                            break;
                        }
                    }

                    foundData = true;
                }

                // æŸ¥æ‰¾Wire fee / Wire Fix Sum Pay - ä¼˜åŒ–è¯†åˆ«
                if (rowStr.includes('wire fee') ||
                    rowStr.includes('wire fix sum') ||
                    rowStr.includes('wire transfer') ||
                    (row[4] && String(row[4]).toLowerCase().includes('wire'))) {

                    if (row.length > 14 && row[14] !== '' && row[14] !== null) {
                        baseInfo.wireFee = String(row[14]).trim();
                        foundData = true;
                    }
                }

                // æŸ¥æ‰¾Grand totalè¡Œ
                if (rowStr.includes('grand total settlement amount')) {
                    if (row.length > 14 && row[14] !== '' && row[14] !== null) {
                        baseInfo.grandTotal = String(row[14]).trim();
                        foundData = true;
                    }
                }
            }

            if (!foundData) {
                return null;
            }

            return baseInfo;
        }

        /** æ˜¾ç¤ºIC++é‡‘é¢æ±‡æ€»è¡¨æ ¼ */
        function displayIcplusAmountTable() {
            const amountTbody = document.querySelector('#icplusAmountTableBody');
            amountTbody.innerHTML = '';

            gIcplusAmountData.forEach((rowData) => {
                const row = document.createElement('tr');

                // Settlement ID
                const td1 = document.createElement('td');
                td1.textContent = rowData.settlementId || '';
                row.appendChild(td1);

                // Settlement Date
                const td2 = document.createElement('td');
                td2.textContent = rowData.settlementDate || '';
                row.appendChild(td2);

                // Processing Period
                const td3 = document.createElement('td');
                td3.textContent = rowData.capturedPeriod || '';
                row.appendChild(td3);

                // Wallet ID
                const td4 = document.createElement('td');
                td4.textContent = rowData.walletId || '';
                row.appendChild(td4);

                // Processing Currency
                const td5 = document.createElement('td');
                td5.textContent = rowData.processingCurrency || '';
                row.appendChild(td5);

                // Transaction Amount
                const td6 = document.createElement('td');
                td6.className = 'amount-cell';
                const transactionAmount = formatLargeNumber(rowData.transactionAmount);
                td6.textContent = transactionAmount || '';
                if (transactionAmount && transactionAmount.startsWith('-')) {
                    td6.classList.add('negative-amount');
                }
                row.appendChild(td6);

                // Settlement Currency
                const td7 = document.createElement('td');
                td7.textContent = rowData.settlementCurrency || '';
                row.appendChild(td7);

                // Settlement Amount
                const td8 = document.createElement('td');
                td8.className = 'amount-cell';
                const settlementAmount = formatLargeNumber(rowData.settlementAmount);
                td8.textContent = settlementAmount || '';
                if (settlementAmount && settlementAmount.startsWith('-')) {
                    td8.classList.add('negative-amount');
                }
                row.appendChild(td8);

                // Interchange Fee
                const td9 = document.createElement('td');
                td9.className = 'amount-cell';
                const interchangeFee = formatLargeNumber(rowData.interchangeFee);
                td9.textContent = interchangeFee || '';
                if (interchangeFee && interchangeFee.startsWith('-')) {
                    td9.classList.add('negative-amount');
                }
                row.appendChild(td9);

                // Scheme Fee
                const td10 = document.createElement('td');
                td10.className = 'amount-cell';
                const schemeFee = formatLargeNumber(rowData.schemeFee);
                td10.textContent = schemeFee || '';
                if (schemeFee && schemeFee.startsWith('-')) {
                    td10.classList.add('negative-amount');
                }
                row.appendChild(td10);

                // Acquirer Fee
                const td11 = document.createElement('td');
                td11.className = 'amount-cell';
                const acquirerFee = formatLargeNumber(rowData.acquirerFee);
                td11.textContent = acquirerFee || '';
                if (acquirerFee && acquirerFee.startsWith('-')) {
                    td11.classList.add('negative-amount');
                }
                row.appendChild(td11);

                // TOTAL NET AMOUNT
                const td12 = document.createElement('td');
                td12.className = 'amount-cell';
                const netAmount = formatLargeNumber(rowData.totalNetAmount);
                td12.textContent = netAmount || '';
                if (netAmount && netAmount.startsWith('-')) {
                    td12.classList.add('negative-amount');
                }
                row.appendChild(td12);

                // RR%
                const td13 = document.createElement('td');
                td13.className = 'percent-cell';
                td13.textContent = formatPercentForDisplay(rowData.rrPercent) || '';
                row.appendChild(td13);

                // Rolling Reserve held
                const td14 = document.createElement('td');
                td14.className = 'amount-cell';
                const reserveHeld = formatLargeNumber(rowData.rollingReserveHeld);
                td14.textContent = reserveHeld || '';
                if (reserveHeld && reserveHeld.startsWith('-')) {
                    td14.classList.add('negative-amount');
                }
                row.appendChild(td14);

                // Rolling Reserve released
                const td15 = document.createElement('td');
                td15.className = 'amount-cell';
                const reserveReleased = formatLargeNumber(rowData.rollingReserveReleased);
                td15.textContent = reserveReleased || '';
                if (reserveReleased && reserveReleased.startsWith('-')) {
                    td15.classList.add('negative-amount');
                }
                row.appendChild(td15);

                // Rolling Reserve released Period
                const td16 = document.createElement('td');
                td16.textContent = rowData.reserveReleasedPeriod || '';
                row.appendChild(td16);

                // Wire fee
                const td17 = document.createElement('td');
                td17.className = 'amount-cell';
                const wireFee = formatLargeNumber(rowData.wireFee);
                td17.textContent = wireFee || '';
                if (wireFee && wireFee.startsWith('-')) {
                    td17.classList.add('negative-amount');
                }
                row.appendChild(td17);

                // Other
                const td18 = document.createElement('td');
                td18.className = 'amount-cell';
                const otherFee = formatLargeNumber(rowData.otherFee);
                td18.textContent = otherFee || '';
                if (otherFee && otherFee.startsWith('-')) {
                    td18.classList.add('negative-amount');
                }
                row.appendChild(td18);

                // GRAND TOTAL
                const td19 = document.createElement('td');
                td19.className = 'amount-cell';
                const grandTotal = formatLargeNumber(rowData.grandTotal);
                td19.textContent = grandTotal || '';
                if (grandTotal && grandTotal.startsWith('-')) {
                    td19.classList.add('negative-amount');
                }
                row.appendChild(td19);

                // Site
                const td20 = document.createElement('td');
                td20.textContent = rowData.site || '';
                td20.className = 'site-cell';
                row.appendChild(td20);

                // Source File
                const td21 = document.createElement('td');
                td21.textContent = rowData.sourceFile || '';
                td21.style.whiteSpace = 'normal';
                td21.style.maxWidth = '200px';
                td21.style.wordBreak = 'break-all';
                row.appendChild(td21);

                amountTbody.appendChild(row);
            });
        }

        /** å¯¼å‡ºIC++é‡‘é¢æ±‡æ€» Excel */
        function downloadIcplusAmountExcel() {
            if(!gIcplusAmountData.length){
                alert(currentLang === 'zh' ? 'æ²¡æœ‰å¯å¯¼å‡ºçš„é‡‘é¢æ•°æ®' : 'No amount data available for export');
                return;
            }

            try {
                const worksheetData = [
                    [
                        'Settlement ID',
                        'Settlement Date',
                        'Processing Period',
                        'Wallet ID',
                        'Processing Currency',
                        'Transaction Amount',
                        'Settlement Currency',
                        'Settlement Amount',
                        'Interchange Fee',
                        'Scheme Fee',
                        'Acquirer Fee',
                        'TOTAL NET AMOUNT',
                        'RR%',
                        'Rolling Reserve held',
                        'Rolling Reserve released',
                        'Rolling Reserve released Period',
                        'Wire fee',
                        'Other',
                        'GRAND TOTAL',
                        'Site',
                        'Source File'
                    ]
                ];

                gIcplusAmountData.forEach(item => {
                    worksheetData.push([
                        item.settlementId || '',
                        item.settlementDate || '',
                        item.capturedPeriod || '',
                        item.walletId || '',
                        item.processingCurrency || '',
                        cleanNumberForExport(item.transactionAmount),
                        item.settlementCurrency || '',
                        cleanNumberForExport(item.settlementAmount),
                        cleanNumberForExport(item.interchangeFee),
                        cleanNumberForExport(item.schemeFee),
                        cleanNumberForExport(item.acquirerFee),
                        cleanNumberForExport(item.totalNetAmount),
                        cleanPercentForExport(item.rrPercent),
                        cleanNumberForExport(item.rollingReserveHeld),
                        cleanNumberForExport(item.rollingReserveReleased),
                        item.reserveReleasedPeriod || '',
                        cleanNumberForExport(item.wireFee),
                        cleanNumberForExport(item.otherFee),
                        cleanNumberForExport(item.grandTotal),
                        item.site || '',
                        item.sourceFile || ''
                    ]);
                });

                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                // å®šä¹‰æ•°å­—åˆ—ï¼ˆé‡‘é¢åˆ—ï¼‰çš„ç´¢å¼•
                const numberColumns = [5, 7, 8, 9, 10, 11, 13, 14, 16, 17, 18];
                const percentColumn = 12;

                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let row = range.s.r + 1; row <= range.e.r; row++) {
                    for (const col of numberColumns) {
                        const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                        const cell = worksheet[cellAddress];

                        if (cell && cell.v !== null && cell.v !== '') {
                            cell.t = 'n';
                            cell.z = '#,##0.00';

                            if (cell.v < 0) {
                                cell.s = {
                                    font: { color: { rgb: "FF0000" } }
                                };
                            }
                        }
                    }

                    const percentCellAddress = XLSX.utils.encode_cell({r: row, c: percentColumn});
                    const percentCell = worksheet[percentCellAddress];

                    if (percentCell && percentCell.v !== null && percentCell.v !== '') {
                        percentCell.t = 'n';
                        percentCell.z = '0.00%';
                    }
                }

                const colWidths = [
                    { wch: 15 },  // Settlement ID
                    { wch: 12 },  // Settlement Date
                    { wch: 25 },  // Processing Period
                    { wch: 12 },  // Wallet ID
                    { wch: 18 },  // Processing Currency
                    { wch: 18 },  // Transaction Amount
                    { wch: 18 },  // Settlement Currency
                    { wch: 18 },  // Settlement Amount
                    { wch: 15 },  // Interchange Fee
                    { wch: 12 },  // Scheme Fee
                    { wch: 15 },  // Acquirer Fee
                    { wch: 18 },  // TOTAL NET AMOUNT
                    { wch: 8 },   // RR%
                    { wch: 18 },  // Rolling Reserve held
                    { wch: 20 },  // Rolling Reserve released
                    { wch: 30 },  // Rolling Reserve released Period
                    { wch: 12 },  // Wire fee
                    { wch: 12 },  // Other
                    { wch: 15 },  // GRAND TOTAL
                    { wch: 25 },  // Site
                    { wch: 35 }   // Source File
                ];

                worksheet['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(workbook, worksheet, 'IC++ç»“ç®—å•ä¿¡æ¯');

                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `IC++ç»“ç®—å•ä¿¡æ¯_${dateStr}_${gIcplusAmountData.length}æ¡è®°å½•.xlsx`;

                XLSX.writeFile(workbook, fileName);

                alert(currentLang === 'zh' ?
                    `æ–‡ä»¶å·²å¯¼å‡º: ${fileName}ï¼ŒåŒ…å« ${gIcplusAmountData.length} æ¡è®°å½•` :
                    `File exported: ${fileName}, containing ${gIcplusAmountData.length} records`);
            } catch (error) {
                console.error(currentLang === 'zh' ? 'å¯¼å‡ºExcelæ—¶å‡ºé”™:' : 'Error exporting Excel:', error);
                alert(currentLang === 'zh' ? `å¯¼å‡ºExcelæ—¶å‡ºé”™: ${error.message}` : `Error exporting Excel: ${error.message}`);
            }
        }
        
        /* ---------- äº¤æ˜“ä¿¡æ¯æå–å‡½æ•° ---------- */
        function extractTransactions(raw, fileName){
            const transactions = [];
            
            // æ‰¾åˆ°è¡¨å¤´è¡Œï¼ˆåŒ…å«"Order ID"çš„è¡Œï¼‰
            const headerRowIndex = raw.findIndex(row => 
                row[0] && row[0].toString().includes('Order ID')
            );
            
            if (headerRowIndex === -1) return transactions;
            
            // è·å–è¡¨å¤´
            const headers = raw[headerRowIndex];
            
            // ä»è¡¨å¤´ä¸‹ä¸€è¡Œå¼€å§‹æå–æ•°æ®ï¼Œç›´åˆ°é‡åˆ°ç©ºè¡Œæˆ–Totalè¡Œ
            for (let i = headerRowIndex + 1; i < raw.length; i++) {
                const row = raw[i];
                
                // è·³è¿‡ç©ºè¡Œå’ŒTotalè¡Œ
                if (!row || row.length === 0 || (row[0] && row[0].toString().includes('Total'))) {
                    continue;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®è¡Œï¼ˆOrder IDåº”è¯¥æ˜¯æ•°å­—æˆ–åŒ…å«æ•°å­—ï¼‰
                if (row[0] && (row[0].toString().match(/\d+\.\d+/) || row[0].toString().match(/\d+/))) {
                    const transaction = {};
                    
                    // æå–æ‰€æœ‰åˆ—çš„æ•°æ®
                    headers.forEach((header, index) => {
                        if (header && header.toString().trim()) {
                            const value = row[index] !== undefined ? row[index] : '';
                            transaction[header.toString().trim()] = value;
                        }
                    });
                    
                    if (Object.keys(transaction).length > 0) {
                        transactions.push(transaction);
                    }
                }
            }
            
            return transactions;
        }
        
        /* ---------- äº¤æ˜“ä¿¡æ¯é¢„è§ˆ ---------- */
        async function previewTransactions(){
            const files = Array.from(document.getElementById('icplusFileInput').files);
            if(!files.length){
                alert(currentLang === 'zh' ? 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶' : 'Please upload report files first');
                return;
            }

            gTransactionFormattedRows = [];
            gIcplusAmountData = [];
            const tbody = document.querySelector('#icplusTableBody');
            tbody.innerHTML = '';
            const amountTbody = document.querySelector('#icplusAmountTableBody');
            amountTbody.innerHTML = '';

            let totalTransactions = 0;
            let amountRecords = 0;

            for (const file of files){
                try {
                    // ä»æ–‡ä»¶åæå–settlement ID
                    const settlementId = file.name.match(/.*_(\d+)_.*\.xlsx$/)?.[1] || '';

                    const data = await file.arrayBuffer();
                    const wb   = XLSX.read(data, {type:'array'});

                    // ===== æå–äº¤æ˜“æ•°æ® =====
                    // æŸ¥æ‰¾Transaction Report sheet
                    const transactionSheetName = wb.SheetNames.find(name =>
                        name.toLowerCase().includes('transaction')
                    );

                    if (transactionSheetName) {
                        const ws = wb.Sheets[transactionSheetName];
                        const raw = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
                        const transactions = extractTransactions(raw, file.name);

                        transactions.forEach(transaction => {
                            // æ ¼å¼åŒ–æ•°æ®ï¼ˆç”¨äºæ˜¾ç¤ºå’Œå¯¼å‡ºï¼‰
                            const formattedRow = [
                                transaction['Order ID'] || '',
                                formatExcelDate(transaction['Date']) || '', // æ ¼å¼åŒ–æ—¥æœŸ
                                transaction['Type'] || '',
                                formatNumberForExport(transaction['Transaction Amount']) || '', // æ•°å­—æ ¼å¼
                                transaction['Transaction Currency'] || '',
                                formatNumberForExport(transaction['Settlement Amount']) || '', // æ•°å­—æ ¼å¼
                                transaction['Settlement Currency'] || '',
                                formatNumberForExport(transaction['Interchange Fee']) || '', // æ•°å­—æ ¼å¼ï¼Œä¿ç•™2ä½å°æ•°
                                formatNumberForExport(transaction['Scheme Fee']) || '', // æ•°å­—æ ¼å¼ï¼Œä¿ç•™2ä½å°æ•°
                                formatNumberForExport(transaction['Acquirer Fee']) || '', // æ•°å­—æ ¼å¼ï¼Œä¿ç•™2ä½å°æ•°
                                formatNumberForExport(transaction['Fees']) || '', // æ•°å­—æ ¼å¼
                                formatNumberForExport(transaction['Net Amount']) || '', // æ•°å­—æ ¼å¼
                                transaction['Card Brand'] || '',
                                transaction['Card Product'] || '',
                                transaction['Card Number'] || '',
                                transaction['Card Holder'] || '',
                                transaction['Card Issuer'] || '',
                                transaction['Card Country'] || '',
                                transaction['Customer Country'] || '',
                                transaction['3DS'] || '',
                                transaction['MerchantOrderID'] || '',
                                transaction['ARN'] || '',
                                transaction['Wallet ID'] || '',
                                transaction['Region'] || '',
                                transaction['Details'] || '',
                                settlementId
                            ];

                            gTransactionFormattedRows.push(formattedRow);
                            totalTransactions++;

                            // åˆ›å»ºæ˜¾ç¤ºè¡Œï¼ˆæ·»åŠ åƒåˆ†ä½æ ¼å¼ï¼‰
                            const displayRow = [
                                transaction['Order ID'] || '',
                                formatExcelDate(transaction['Date']) || '',
                                transaction['Type'] || '',
                                formatLargeNumber(transaction['Transaction Amount']) || '',
                                transaction['Transaction Currency'] || '',
                                formatLargeNumber(transaction['Settlement Amount']) || '',
                                transaction['Settlement Currency'] || '',
                                formatNumber(transaction['Interchange Fee']) || '',
                                formatNumber(transaction['Scheme Fee']) || '',
                                formatNumber(transaction['Acquirer Fee']) || '',
                                formatNumber(transaction['Fees']) || '',
                                formatLargeNumber(transaction['Net Amount']) || '',
                                transaction['Card Brand'] || '',
                                transaction['Card Product'] || '',
                                transaction['Card Number'] || '',
                                transaction['Card Holder'] || '',
                                transaction['Card Issuer'] || '',
                                transaction['Card Country'] || '',
                                transaction['Customer Country'] || '',
                                transaction['3DS'] || '',
                                transaction['MerchantOrderID'] || '',
                                transaction['ARN'] || '',
                                transaction['Wallet ID'] || '',
                                transaction['Region'] || '',
                                transaction['Details'] || '',
                                settlementId
                            ];

                            const tr = document.createElement('tr');
                            displayRow.forEach(v=>{
                                const td = document.createElement('td');
                                td.textContent = v;
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });

                        console.log(currentLang === 'zh' ?
                            `ä»æ–‡ä»¶ ${file.name} æå–äº† ${transactions.length} æ¡äº¤æ˜“è®°å½•ï¼ŒSettlement ID: ${settlementId}` :
                            `Extracted ${transactions.length} transaction records from ${file.name}, Settlement ID: ${settlementId}`);
                    } else {
                        console.warn(currentLang === 'zh' ? 'æœªæ‰¾åˆ°Transaction Report sheet:' : 'Transaction Report sheet not found:', file.name);
                    }

                    // ===== æå–é‡‘é¢æ±‡æ€»æ•°æ® =====
                    // åªå¤„ç† Settlement Report å·¥ä½œè¡¨ï¼Œé¿å…é‡å¤
                    let targetSheetName = null;
                    for (let i = 0; i < wb.SheetNames.length; i++) {
                        const sheetName = wb.SheetNames[i];
                        if (sheetName.toLowerCase().includes('settlement')) {
                            targetSheetName = sheetName;
                            break;
                        }
                    }

                    if (targetSheetName) {
                        const worksheet = wb.Sheets[targetSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                        const sheetInfo = extractIcplusInfoFromSheet(jsonData, file.name, targetSheetName);
                        if (sheetInfo) {
                            gIcplusAmountData.push(sheetInfo);
                            amountRecords++;
                        }
                    }

                } catch (e) {
                    console.error(currentLang === 'zh' ? 'å¤„ç†æ–‡ä»¶å‡ºé”™:' : 'Error processing file:', file.name, e);
                }
            }

            // æ˜¾ç¤ºé‡‘é¢æ±‡æ€»è¡¨æ ¼
            if (gIcplusAmountData.length > 0) {
                displayIcplusAmountTable();
                document.getElementById('icplusAmountTableContainer').style.display = 'block';
                document.getElementById('icplusAmountPreviewTable').style.display = 'table';
            }

            // æ˜¾ç¤ºäº¤æ˜“æ•°æ®è¡¨æ ¼
            if (gTransactionFormattedRows.length > 0) {
                document.getElementById('icplusTableContainer').style.display = 'block';
                document.getElementById('icplusPreviewTable').style.display = 'table';
            }

            // æ˜¾ç¤ºæ ‡ç­¾é¡µå®¹å™¨
            document.getElementById('icplusReportTabs').style.display = 'block';

            // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
            document.getElementById('downloadIcplusBtn').style.display = 'block';
            document.getElementById('downloadIcplusTransactionsBtn').style.display = 'block';
            document.getElementById('downloadIcplusAmountBtn').style.display = 'block';
            document.getElementById('icplusSummary').style.display = 'block';

            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            const summaryText = currentLang === 'zh' ?
                `å·²æå– ${totalTransactions} æ¡äº¤æ˜“è®°å½•ï¼Œ${amountRecords} æ¡é‡‘é¢è®°å½•` :
                `Extracted ${totalTransactions} transaction records, ${amountRecords} amount records`;
            document.getElementById('icplusSummaryText').textContent = summaryText;

            alert((currentLang === 'zh' ? 'å…±æå–äº† ' : 'Extracted ') + totalTransactions +
                  (currentLang === 'zh' ? ' æ¡äº¤æ˜“è®°å½•å’Œ ' : ' transaction records and ') +
                  amountRecords + (currentLang === 'zh' ? ' æ¡é‡‘é¢è®°å½•' : ' amount records'));
        }
        
        /* ---------- IC++å¯¼å‡ºExcelï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰ ---------- */
        function downloadIcplusExcel() {
            // æ ¹æ®å½“å‰æ ‡ç­¾é¡µå†³å®šå¯¼å‡ºå“ªä¸ªæŠ¥è¡¨
            if (currentIcplusTab === 'transactions') {
                downloadIcplusTransactionExcel();
            } else {
                downloadIcplusAmountExcel();
            }
        }

        /* ---------- å¯¼å‡ºIC++äº¤æ˜“ä¿¡æ¯ Excel ---------- */
        function downloadIcplusTransactionExcel(){
            if(!gTransactionFormattedRows.length){
                alert(currentLang === 'zh' ? 'æ²¡æœ‰å¯å¯¼å‡ºçš„äº¤æ˜“æ•°æ®' : 'No transaction data available for export');
                return;
            }

            const headers = [
                'Order ID', 'Date', 'Type', 'Transaction Amount', 'Transaction Currency',
                'Settlement Amount', 'Settlement Currency', 'Interchange Fee', 'Scheme Fee',
                'Acquirer Fee', 'Fees', 'Net Amount', 'Card Brand', 'Card Product',
                'Card Number', 'Card Holder', 'Card Issuer', 'Card Country', 'Customer Country',
                '3DS', 'MerchantOrderID', 'ARN', 'Wallet ID', 'Region', 'Details', 'Settlement ID'
            ];

            // åˆ›å»ºå·¥ä½œè¡¨æ•°æ® - ä½¿ç”¨å·²ç»æ ¼å¼åŒ–çš„æ•°æ®
            const ws_data = [headers];
            ws_data.push(...gTransactionFormattedRows);

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');

            // å†™å…¥æ–‡ä»¶
            XLSX.writeFile(wb, 'icplus_transactions.xlsx');
        }
        
        /* ---------- IC++æŠ¥è¡¨é‡ç½® ---------- */
        function resetIcplusTool(){
            document.getElementById('icplusFileInput').value = '';
            document.getElementById('icplusSelectedFiles').textContent = '';
            document.getElementById('icplusTableBody').innerHTML = '';
            document.getElementById('icplusTableContainer').style.display = 'none';
            document.getElementById('icplusPreviewTable').style.display = 'none';
            document.getElementById('icplusAmountTableBody').innerHTML = '';
            document.getElementById('icplusAmountTableContainer').style.display = 'none';
            document.getElementById('icplusAmountPreviewTable').style.display = 'none';
            document.getElementById('icplusReportTabs').style.display = 'none';
            document.getElementById('downloadIcplusBtn').style.display = 'none';
            document.getElementById('downloadIcplusTransactionsBtn').style.display = 'none';
            document.getElementById('downloadIcplusAmountBtn').style.display = 'none';
            document.getElementById('icplusSummary').style.display = 'none';
            gTransactionFormattedRows = [];
            gIcplusAmountData = [];
        }
        
        // ==================== General Report Helper Functions ====================
        
        /** ä» Excel å‰å‡ è¡ŒæŠ½å– Meta èµ„è®¯ */
        function extractMeta(file) {
            const meta = {};
            file.forEach(row => {
                const line = row.join(" ");
                if (line.includes("Site:")) meta["Site"] = line.split("Site:")[1].trim();
                if (line.includes("Acquirer:")) meta["Acquirer"] = line.split("Acquirer:")[1].trim();
                if (line.includes("Settlement ID:")) meta["Settlement ID"] = line.split("Settlement ID:")[1].trim();
                if (line.includes("Settlement Date:")) meta["Settlement Date"] = line.split("Settlement Date:")[1].trim();
                if (line.includes("Captured Period:")) meta["Captured Period"] = line.split("Captured Period:")[1].trim();
                if (line.includes("Processing Currency:")) meta["Processing Currency"] = line.split("Processing Currency:")[1].trim();
                if (line.includes("Settlement Currency:")) meta["Settlement Currency"] = line.split("Settlement Currency:")[1].trim();
            });
            return meta;
        }

        /** ä» Excel æŠ½å– Fee Meta */
        function extractFee(file) {
            const meta = {};
            let start = false, end = false;

            file.forEach(row => {
                const line = row.join(" ");
                if (line.includes("TOTAL NET AMOUNT")) start = true;
                if (line.includes("GRAND TOTAL")) { start = false; end = true; }
                if (start && !end) {
                    const clearRow = row.filter(item => item !== "");
                    if (clearRow.length >= 3) {
                        const text = "Rolling Reserve held for the period"
                        if (clearRow[0].includes(text)) {
                            const splited = clearRow[0].split(text)
                            meta[text] = `${clearRow[1]} ${clearRow[2]} (${splited[1]})`
                            return
                        }

                        meta[clearRow[0].replace(/"/g, "").trim()] = `${clearRow[1]} ${clearRow[2]}`;
                    }
                }
            });

            return meta;
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ 
            initDragDrop();
            
            // åˆå§‹è¯­è¨€è®¾ç½®
            switchLanguage('zh');
        });
    </script>
</body>
</html>